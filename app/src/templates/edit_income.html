{# src/templates/edit_income.html #}
{% extends "base.html" %}

{% block content %}
  <h2>Edit Income</h2>

  <form
    method="POST"
    action="{{ url_for('main.incomes', income_id=income.id) }}"
    class="row g-3 mb-4"
  >
    {% if csrf_token %}
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    {% endif %}

    <div class="col-md-3">
      <div class="d-flex align-items-center">
        <select name="account_id" class="form-select me-2" required>
          <option value="">Select an Account</option>
          {% for acct in accounts %}
            <option
              value="{{ acct.id }}"
              {% if acct.id == income.account_id %}selected{% endif %}
            >
              {{ acct.name }}
            </option>
          {% endfor %}
        </select>
        <a href="{{ url_for('main.accounts') }}" class="btn btn-link p-0">
          Manage
        </a>
      </div>
    </div>

    <div class="col-md-2">
      <input
        type="text"
        name="name"
        class="form-control"
        placeholder="Income Source"
        value="{{ income.name }}"
        required
      />
    </div>

    <div class="col-md-2">
      <input
        type="number"
        step="0.01"
        name="amount"
        class="form-control"
        placeholder="Amount"
        value="{{ income.amount }}"
        required
      />
    </div>

    <div class="col-md-2">
      <select name="frequency" class="form-select" required>
        <option value="">Frequency</option>
        {% for f in freqs %}
          <option
            value="{{ f }}"
            {% if f == income.frequency %}selected{% endif %}
          >
            {{ f.replace('_',' ').title() }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div
      id="date-input"
      class="col-md-2"
      {% if income.frequency == 'twice_monthly' %}style="display:none"{% endif %}
    >
      <input
        type="date"
        name="next_pay"
        class="form-control"
        value="{{ income.next_pay }}"
        {% if income.frequency != 'twice_monthly' %}required{% endif %}
      />
    </div>

    <div
      id="twice-input"
      class="col-md-4"
      {% if income.frequency != 'twice_monthly' %}style="display:none"{% endif %}
    >
      <div class="row g-3">
        <div class="col">
          <input
            type="number"
            name="day1"
            class="form-control"
            placeholder="Day 1"
            min="1"
            max="31"
            value="{{ income.day_of_month_1 }}"
            {% if income.frequency == 'twice_monthly' %}required{% endif %}
          />
        </div>
        <div class="col">
          <input
            type="number"
            name="day2"
            class="form-control"
            placeholder="Day 2"
            min="1"
            max="31"
            value="{{ income.day_of_month_2 }}"
            {% if income.frequency == 'twice_monthly' %}required{% endif %}
          />
        </div>
      </div>
    </div>

    <div class="col-md-2">
      <button type="submit" class="btn btn-success w-100">
        Save Changes
      </button>
    </div>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const freq     = document.querySelector('select[name="frequency"]');
      const dateDiv  = document.getElementById('date-input');
      const dateIn   = dateDiv.querySelector('input[name="next_pay"]');
      const twiceDiv = document.getElementById('twice-input');

      function toggleFields() {
        const isTwice = freq.value === 'twice_monthly';
        dateDiv.style.display  = isTwice ? 'none'  : 'block';
        twiceDiv.style.display = isTwice ? 'block' : 'none';

        dateIn.required = !isTwice;
        if (isTwice) dateIn.value = '';

        twiceDiv.querySelectorAll('input').forEach(i => {
          i.required = isTwice;
        });
      }

      freq.addEventListener('change', toggleFields);
      toggleFields();
    });
  </script>
{% endblock %}
